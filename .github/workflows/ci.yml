  name: CI/CD Pipeline

  on:
    push:
      branches:
        - main
    pull_request:
      branches:
        - main
        
  jobs:
    build:
      runs-on: ubuntu-latest
      services:
        postgres:
          image: postgres:13
          env:
            POSTGRES_DB: IS_lab1 
            POSTGRES_USER: root
            POSTGRES_PASSWORD: ROOT
          ports:
            - 5432:5432
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

      steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Start PostgreSQL container
        run: |
        docker run --name postgres -p 5432:5432 -e POSTGRES_DB=IS_lab1 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=ROOT -d postgres:13
      
      # Ждем, пока PostgreSQL будет готов
      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL..."
          while ! docker exec postgres pg_isready --host=localhost --port=5432; do
            sleep 3 # ждем 3 секунды, чтобы дать базе данных запуститься
          done
          echo "PostgreSQL is ready!"

      - name: Build with Maven
        run: mvn clean install -Dspring.profiles.active=test
        working-directory: ./lab1

      - name: Run OWASP Dependency-Check
        run: mvn org.owasp:dependency-check-maven:check -Ddc.nvd.apiKey=${{ secrets.NVD_API_KEY }}
        working-directory: ./lab1
