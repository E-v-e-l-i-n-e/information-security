  name: CI/CD Pipeline

  on:
    push:
      branches:
        - main
    pull_request:
      branches:
        - main
        
  jobs:
    build:
      runs-on: ubuntu-latest
      services:
        postgres:
          image: postgres:13
          env:
            POSTGRES_DB: IS_lab1 
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: ROOT
          ports:
            - 5432:5432
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

  permissions:
    contents: read
    security-events: write
    
      steps:
      - name: Checkout code
        uses: actions/checkout@v4

     
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          working-directory: ./lab1 

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven
        run: mvn clean install -Dspring.profiles.active=test
        working-directory: ./lab1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          working-directory: ./lab1 

      - name: Run OWASP Dependency-Check
      
        run: mvn org.owasp:dependency-check-maven:check -Ddc.nvd.apiKey=${{ secrets.NVD_API_KEY }} -Dformat=ALL
        working-directory: ./lab1

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-html
          path: lab1/target/dependency-check-report.html
          retention-days: 5
